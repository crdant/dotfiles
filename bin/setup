#!/bin/sh

mkdir -p ${HOME}/.dotfiles.bak

if [ -n "${MY_DIR}" ] ; then
  DOTFILES=${HOME}/.dotfiles
else
  SELFPATH=$(cd -P -- "$(dirname -- "$0")" && pwd -P) && SELFPATH=${SELFPATH}/$(basename -- "$0")
  SELFDIR=`dirname ${SELFPATH}`
  DOTFILES=`dirname ${SELFDIR}`
fi

# make sure the SSH config directory exists with appropriate permissions
if [ ! -d ${HOME}/.ssh ] ; then
    mkdir ${HOME}/.ssh
fi
chmod 700 ${HOME}/.ssh

# setup various dotfiles
DATESTAMP=$(date +%Y%m%dT%H%M%S)
mv ${HOME}/.ackrc ${HOME}/.dotfiles.bak/ackrc.${DATESTAMP}
ln -sf ${DOTFILES}/ackrc ${HOME}/.ackrc

mv ${HOME}/.curlrc ${HOME}/.dotfiles.bak/curlrc.${DATESTAMP}
ln -sf ${DOTFILES}/curlrc ${HOME}/.curlrc

mv ${HOME}/.editorconfig ${HOME}/.dotfiles.bak/editorconfig.${DATESTAMP}
ln -sf ${DOTFILES}/editorconfig ${HOME}/.editorconfig

mv ${HOME}/.emacs ${HOME}/.dotfiles.bak/emacs.${DATESTAMP}
ln -sf ${DOTFILES}/emacs ${HOME}/.emacs

mv ${HOME}/.ssh/config ${HOME}/.dotfiles.bak/ssh-config.${DATESTAMP}
ln -sf ${DOTFILES}/ssh/config ${HOME}/.ssh/config

mv ${HOME}/.gitconfig ${HOME}/.dotfiles.bak/gitconfig.${DATESTAMP}
ln -sf ${DOTFILES}/gitconfig ${HOME}/.gitconfig

mv ${HOME}/.packerconfig ${HOME}/.dotfiles.bak/packerconfig.${DATESTAMP}
ln -sf ${DOTFILES}/packerconfig ${HOME}/.packerconfig

mv ${HOME}/.tm_properties ${HOME}/.dotfiles.bak/tm_properties.${DATESTAMP}
ln -sf ${DOTFILES}/tm_properties ${HOME}/.tm_properties

mv ${HOME}/.zshrc ${HOME}/.dotfiles.bak/zshrc.${DATESTAMP}
ln -sf ${DOTFILES}/zshrc ${HOME}/.zshrc

mv ${HOME}/.zshenv ${HOME}/.dotfiles.bak/zshenv.${DATESTAMP}
ln -sf ${DOTFILES}/zshenv ${HOME}/.zshenv

# confirm SSH with my private key will be allowed
cat ${DOTFILES}/ssh/id_rsa_4096.pub >> ${HOME}/.ssh/authorized_keys
chmod 600 ${HOME}/.ssh/authorized_keys

os="$(uname | awk '{print tolower($1)}')"
if [[ os -eq "darwin"  ]]; then
  # add customized Terminal.app configuration (need to make this only execute on Macs)
  cp ${HOME}/Library/Preferences/com.apple.Terminal.plist ${HOME}/.dotfiles.bak/com.apple.Terminal.plist.${DATESTAMP}
  ln -sf ${DOTFILES}/Library/Preferences/com.apple.Terminal.plist ${HOME}/Library/Preferences/com.apple.Terminal.plist

  # add Bartender configuration (need to make this only execute on Macs)
  cp ${HOME}/Library/Preferences/com.surteesstudios.Bartender.plist ${HOME}/.dotfiles.bak/com.surteesstudios.Bartender.plist.${DATESTAMP}
  ln -sf ${DOTFILES}/Library/Preferences/com.surteesstudios.Bartender.plist ${HOME}/Library/Preferences/com.surteesstudios.Bartender.plist

  # add youtube-dl configuration
  mv ${HOME}/.config/youtube-dl ${HOME}/.dotfiles.bak/youtube-dl.${DATESTAMP}
  ln -sf ${DOTFILES}/.config/youtube-dl ${HOME}/.config/youtube-dl

  # add Pivotal color palette
  cp ${HOME}/Library/Colors/Pivotal.clr ${HOME}/.dotfiles.bak
  ln -sf ${DOTFILES}/Library/Colors/Pivotal.clr ${HOME}/Library/Colors/Pivotal.clr
fi

# add AWS configuration
mv ${HOME}/.aws ${HOME}/.dotfiles.bak/aws.${DATESTAMP}
ln -sf ${DOTFILES}/aws ${HOME}/.aws

# link in atom configuration
mkdir ~/.dotfiles.bak/atom
mv ${HOME}/.atom/config.cson ${HOME}/.dotfiles.bak/atom/
ln -sf ${DOTFILES}/atom/config.cson ${HOME}/.atom/config.cson
