#!/usr/bin/env bash

mkdir -p ${HOME}/.dotfiles.bak
os="$(uname | awk '{print tolower($1)}')"

if [ -n "${MY_DIR}" ] ; then
  DOTFILES=${HOME}/.dotfiles
else
  SELFPATH=$(cd -P -- "$(dirname -- "$0")" && pwd -P) && SELFPATH=${SELFPATH}/$(basename -- "$0")
  SELFDIR=`dirname ${SELFPATH}`
  DOTFILES=`dirname ${SELFDIR}`
fi

# make sure the SSH config directory exists with appropriate permissions
if [ ! -d ${HOME}/.ssh ] ; then
    mkdir ${HOME}/.ssh
fi
chmod 700 ${HOME}/.ssh

# setup various dotfiles
DATESTAMP=$(date +%Y%m%dT%H%M%S)
if [[ -f ${HOME}/.ackrc  ]] ; then
  mv ${HOME}/.ackrc ${HOME}/.dotfiles.bak/ackrc.${DATESTAMP}
fi
ln -sf ${DOTFILES}/ackrc ${HOME}/.ackrc

if [[ -f ${HOME}/.curlrc  ]] ; then
  mv ${HOME}/.curlrc ${HOME}/.dotfiles.bak/curlrc.${DATESTAMP}
fi
ln -sf ${DOTFILES}/curlrc ${HOME}/.curlrc

if [[ -f ${HOME}/.editorconfig  ]] ; then
  mv ${HOME}/.editorconfig ${HOME}/.dotfiles.bak/editorconfig.${DATESTAMP}
fi
ln -sf ${DOTFILES}/editorconfig ${HOME}/.editorconfig

if [[ -f ${HOME}/.emacs  ]] ; then
  mv ${HOME}/.emacs ${HOME}/.dotfiles.bak/emacs.${DATESTAMP}
fi
ln -sf ${DOTFILES}/emacs ${HOME}/.emacs

if [[ -d ${HOME}/.config/nvim ]] ; then
  mv ${HOME}/.config/nvim ${HOME}/.dotfiles.bak/nvim.${DATESTAMP}
fi
ln -sf ${DOTFILES}/nvim ${HOME}/.config/nvim

if [[ -f ${HOME}/.ssh/config  ]] ; then
  mv ${HOME}/.ssh/config ${HOME}/.dotfiles.bak/ssh-config.${DATESTAMP}
fi
ln -sf ${DOTFILES}/ssh/config ${HOME}/.ssh/config

if [[ -f ${HOME}/.gitconfig  ]] ; then
  mv ${HOME}/.gitconfig ${HOME}/.dotfiles.bak/gitconfig.${DATESTAMP}
fi
ln -sf ${DOTFILES}/gitconfig.${os} ${HOME}/.gitconfig

if [[ -f ${HOME}/.packerconfig  ]] ; then
  mv ${HOME}/.packerconfig ${HOME}/.dotfiles.bak/packerconfig.${DATESTAMP}
fi
ln -sf ${DOTFILES}/packerconfig ${HOME}/.packerconfig

if [[ -f ${HOME}/.zshrc  ]] ; then
  mv ${HOME}/.zshrc ${HOME}/.dotfiles.bak/zshrc.${DATESTAMP}
fi
ln -sf ${DOTFILES}/zshrc ${HOME}/.zshrc

if [[ -f ${HOME}/.zshenv  ]] ; then
  mv ${HOME}/.zshenv ${HOME}/.dotfiles.bak/zshenv.${DATESTAMP}
fi
ln -sf ${DOTFILES}/zshenv ${HOME}/.zshenv

# confirm SSH with my private key will be allowed
cat ${DOTFILES}/ssh/id_rsa_4096.pub >> ${HOME}/.ssh/authorized_keys
chmod 600 ${HOME}/.ssh/authorized_keys

if [[ ! -d ${HOME}/.config/ ]]; then
  mkdir ${HOME}/.config
fi

# add youtube-dl configuration
if [[ -f ${HOME}/.config/youtube-dl  ]] ; then
  mv ${HOME}/.config/youtube-dl ${HOME}/.dotfiles.bak/youtube-dl.${DATESTAMP}
fi
ln -sf ${DOTFILES}/.config/youtube-dl ${HOME}/.config/youtube-dl

if [[ os == "darwin"  ]]; then
  # add customized Terminal.app configuration (need to make this only execute on Macs)
  cp ${HOME}/Library/Preferences/com.apple.Terminal.plist ${HOME}/.dotfiles.bak/com.apple.Terminal.plist.${DATESTAMP}
  ln -sf ${DOTFILES}/Library/Preferences/com.apple.Terminal.plist ${HOME}/Library/Preferences/com.apple.Terminal.plist

  # add Bartender configuration (need to make this only execute on Macs)
  cp ${HOME}/Library/Preferences/com.surteesstudios.Bartender.plist ${HOME}/.dotfiles.bak/com.surteesstudios.Bartender.plist.${DATESTAMP}
  ln -sf ${DOTFILES}/Library/Preferences/com.surteesstudios.Bartender.plist ${HOME}/Library/Preferences/com.surteesstudios.Bartender.plist

  # add Pivotal color palette
  cp ${HOME}/Library/Colors/Pivotal.clr ${HOME}/.dotfiles.bak
  ln -sf ${DOTFILES}/Library/Colors/Pivotal.clr ${HOME}/Library/Colors/Pivotal.clr
  
  if [[ -d ${HOME}/.keyboard ]]; then
    mv ${HOME}/.keyboard ~/.dotfiles.bak/keyboard.${DATESTAMP}
  fi
  ln -sf ${DOTFILES}/keyboard ${HOME}/.keyboard

  if [[ -d ${HOME}/.config/karabiner ]]; then
    mv ${HOME}/.config ~/.dotfiles.bak/karabiner.${DATESTAMP}
  fi
  ln -sf ${DOTFILES}/karabiner ${HOME}/.config/karabiner
fi


# add youtube-dl configuration
if [[ -d ${HOME}/.aws  ]] ; then
  mv ${HOME}/.aws ${HOME}/.dotfiles.bak/aws.${DATESTAMP}
fi
ln -sf ${DOTFILES}/aws ${HOME}/.aws

# link in atom configuration
if [[ -d ${HOME}/.atom  ]] ; then
  mkdir ${HOME}/.dotfiles.bak/atom.${DATESTAMP}
  mv ${HOME}/.atom/config.cson ${HOME}/.dotfiles.bak/atom/
else
  mkdir ${HOME}/.atom
fi
ln -sf ${DOTFILES}/atom/config.cson ${HOME}/.atom/config.cson

ln -sf ${DOTFILES}/vimrc.local ${HOME}/.vimrc.local
