name: Update sbctl Package
on:
  schedule:
    - cron: '45 */4 * * *'  # Every 4 hours, offset by 45 minutes
  workflow_dispatch:

jobs:
  update-sbctl:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    outputs:
      updated: ${{ steps.check.outputs.updated }}
      old-version: ${{ steps.check.outputs.old-version }}
      new-version: ${{ steps.check.outputs.new-version }}
      darwin-hash: ${{ steps.check.outputs.darwin-hash }}
      linux-hash: ${{ steps.check.outputs.linux-hash }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        
      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main
        
      - name: Check for sbctl updates and update package
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          nix-shell -p python3 python3Packages.requests --run "python3 .github/scripts/update-package.py sbctl"
          
      - name: Test sbctl installation on Linux
        if: steps.check.outputs.updated == 'true'
        run: |
          .github/scripts/test-package.sh sbctl

      - name: Upload modified package file
        if: steps.check.outputs.updated == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: sbctl-package
          path: pkgs/sbctl/default.nix
          retention-days: 1

  test-macos:
    needs: update-sbctl
    if: needs.update-sbctl.outputs.updated == 'true'
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Download modified package file
        uses: actions/download-artifact@v4
        with:
          name: sbctl-package
          path: pkgs/sbctl/

      - name: Test sbctl installation on macOS
        run: |
          .github/scripts/test-package.sh sbctl

  create-pull-request:
    needs: [update-sbctl, test-macos]
    if: needs.update-sbctl.outputs.updated == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Download modified package file
        uses: actions/download-artifact@v4
        with:
          name: sbctl-package
          path: pkgs/sbctl/

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update sbctl to v${{ needs.update-sbctl.outputs.new-version }}"
          title: "chore: update sbctl to v${{ needs.update-sbctl.outputs.new-version }}"
          body: |
            ## Automated Package Update: sbctl (Troubleshoot)

            This is an automated update of the sbctl (Troubleshoot Support Bundle CLI) package.

            ### Changes
            - **Previous version**: ${{ needs.update-sbctl.outputs.old-version }}
            - **New version**: ${{ needs.update-sbctl.outputs.new-version }}
            - **Release notes**: https://github.com/replicatedhq/sbctl/releases/tag/v${{ needs.update-sbctl.outputs.new-version }}

            ### Platform-specific Binary Hashes Updated
            - **Darwin**: `${{ needs.update-sbctl.outputs.darwin-hash }}`
            - **Linux**: `${{ needs.update-sbctl.outputs.linux-hash }}`

            ### Validation
            - Package builds successfully on Linux
            - Package builds successfully on macOS
            - Installation tests passed on both platforms
            - Binary hashes calculated and verified for both platforms

            ### Next Steps
            - Review the changes and ensure they look correct
            - Test the updated package in your environment
            - Merge when ready

            ---
            *This PR was created automatically by the sbctl update workflow*
          branch: update-sbctl-${{ needs.update-sbctl.outputs.new-version }}
          delete-branch: true