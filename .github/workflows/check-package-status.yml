name: Package Status Check
on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:

jobs:
  check-packages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        
      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main
        
      - name: Test all custom packages
        run: |
          echo "üîç Testing all custom packages..."
          
          # List of packages to test
          packages=(
            "vimr"
            "replicated" 
            "kots"
            "sbctl"
          )
          
          failed_packages=()
          
          for pkg in "${packages[@]}"; do
            echo ""
            echo "üì¶ Testing $pkg..."
            if .github/scripts/test-package.sh "$pkg"; then
              echo "‚úÖ $pkg: PASSED"
            else
              echo "‚ùå $pkg: FAILED"
              failed_packages+=("$pkg")
            fi
          done
          
          echo ""
          echo "üìã Summary:"
          echo "Total packages tested: ${#packages[@]}"
          echo "Failed packages: ${#failed_packages[@]}"
          
          if [ ${#failed_packages[@]} -gt 0 ]; then
            echo ""
            echo "‚ùå Failed packages:"
            for pkg in "${failed_packages[@]}"; do
              echo "  - $pkg"
            done
            exit 1
          else
            echo ""
            echo "‚úÖ All packages are building successfully!"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
  test-home-manager:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        
      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main
        
      - name: Test home manager configuration builds
        run: |
          echo "üè† Testing home manager configuration builds..."
          
          # Get list of home configurations
          configs=$(nix eval --impure --json .#homeConfigurations --apply 'builtins.attrNames' | jq -r '.[]')
          
          failed_configs=()
          
          for config in $configs; do
            echo ""
            echo "üîß Testing home configuration: $config"
            if nix build ".#homeConfigurations.$config.activationPackage" --no-link; then
              echo "‚úÖ $config: PASSED"
            else
              echo "‚ùå $config: FAILED"
              failed_configs+=("$config")
            fi
          done
          
          echo ""
          echo "üìã Home Manager Summary:"
          echo "Total configurations tested: $(echo "$configs" | wc -l)"
          echo "Failed configurations: ${#failed_configs[@]}"
          
          if [ ${#failed_configs[@]} -gt 0 ]; then
            echo ""
            echo "‚ùå Failed configurations:"
            for config in "${failed_configs[@]}"; do
              echo "  - $config"
            done
            exit 1
          else
            echo ""
            echo "‚úÖ All home manager configurations are building successfully!"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}